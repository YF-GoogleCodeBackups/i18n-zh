<?xml version="1.0" encoding="UTF-8" standalone="no"?>
<!DOCTYPE html PUBLIC "-//W3C//DTD XHTML 1.0 Transitional//EN" "http://www.w3.org/TR/xhtml1/DTD/xhtml1-transitional.dtd">
<html xmlns="http://www.w3.org/1999/xhtml"><head><meta http-equiv="Content-Type" content="text/html; charset=UTF-8" /><title>第 4 章 从先前的发行版本升级</title><link rel="stylesheet" href="debian.css" type="text/css" /><meta name="generator" content="DocBook XSL Stylesheets V1.73.2" /><link rel="start" href="index.zh_CN.html" title="Debian GNU/Linux 5.0 (&quot;lenny&quot;), Intel x86 的发行注记" /><link rel="up" href="index.zh_CN.html" title="Debian GNU/Linux 5.0 (&quot;lenny&quot;), Intel x86 的发行注记" /><link rel="prev" href="ch-installing.zh_CN.html" title="第 3 章 安装系统" /><link rel="next" href="ch-information.zh_CN.html" title="第 5 章 lenny 中需要注意的问题" /></head><body><div class="navheader"><table width="100%" summary="Navigation header"><tr><th colspan="3" align="center">第 4 章 从先前的发行版本升级</th></tr><tr><td width="20%" align="left"><a accesskey="p" href="ch-installing.zh_CN.html">上一页</a> </td><th width="60%" align="center"> </th><td width="20%" align="right"> <a accesskey="n" href="ch-information.zh_CN.html">下一页</a></td></tr></table><hr /></div><div class="chapter" lang="zh-CN" xml:lang="zh-CN"><div class="titlepage"><div><div><h2 class="title"><a id="ch-upgrading"></a>第 4 章 从先前的发行版本升级</h2></div></div></div><div class="toc"><p><b>目录</b></p><dl><dt><span class="section"><a href="ch-upgrading.zh_CN.html#backup">4.1. 升级前的准备</a></span></dt><dd><dl><dt><span class="section"><a href="ch-upgrading.zh_CN.html#data-backup">4.1.1. 备份数据和配置文件</a></span></dt><dt><span class="section"><a href="ch-upgrading.zh_CN.html#inform-users">4.1.2. 提前告知用户</a></span></dt><dt><span class="section"><a href="ch-upgrading.zh_CN.html#recovery">4.1.3. 准备恢复</a></span></dt><dt><span class="section"><a href="ch-upgrading.zh_CN.html#upgrade-preparations">4.1.4. 为升级准备安全环境</a></span></dt><dt><span class="section"><a href="ch-upgrading.zh_CN.html#prepare-initramfs">4.1.5. 为 <acronym title="Linux 加载器">LILO</acronym> 准备
initramfs</a></span></dt></dl></dd><dt><span class="section"><a href="ch-upgrading.zh_CN.html#system-status">4.2. 检查系统状态</a></span></dt><dd><dl><dt><span class="section"><a href="ch-upgrading.zh_CN.html#review-actions">4.2.1. 复审包管理器中未决的的操作</a></span></dt><dt><span class="section"><a href="ch-upgrading.zh_CN.html#disable-apt-pinning">4.2.2. 禁用 APT pinning 操作</a></span></dt><dt><span class="section"><a href="ch-upgrading.zh_CN.html#package-status">4.2.3. 检查包状态</a></span></dt><dt><span class="section"><a href="ch-upgrading.zh_CN.html#userbackports">4.2.4. 非官方源和 backports</a></span></dt></dl></dd><dt><span class="section"><a href="ch-upgrading.zh_CN.html#handle-conflict">4.3. 手工删除包标记</a></span></dt><dt><span class="section"><a href="ch-upgrading.zh_CN.html#upgrade-process">4.4. 为 APT 准备源</a></span></dt><dd><dl><dt><span class="section"><a href="ch-upgrading.zh_CN.html#network">4.4.1. 添加互联网 APT 源</a></span></dt><dt><span class="section"><a href="ch-upgrading.zh_CN.html#localmirror">4.4.2. 添加本地镜像 APT 源</a></span></dt><dt><span class="section"><a href="ch-upgrading.zh_CN.html#cdroms">4.4.3. 从 CD-ROM 或 DVD 添加 APT 源</a></span></dt></dl></dd><dt><span class="section"><a href="ch-upgrading.zh_CN.html#upgradingpackages">4.5. 升级包</a></span></dt><dd><dl><dt><span class="section"><a href="ch-upgrading.zh_CN.html#record-session">4.5.1. 记录会话</a></span></dt><dt><span class="section"><a href="ch-upgrading.zh_CN.html#updating-lists">4.5.2. 更新包列表</a></span></dt><dt><span class="section"><a href="ch-upgrading.zh_CN.html#sufficient-space">4.5.3. 确保你有足够的空间升级</a></span></dt><dt><span class="section"><a href="ch-upgrading.zh_CN.html#aptupgrade1st">4.5.4. 先升级 apt 和/或 aptitude</a></span></dt><dt><span class="section"><a href="ch-upgrading.zh_CN.html#aptconvert">4.5.5. 使用 aptitudes 记录的 apt 自动安装的软件包列表</a></span></dt><dt><span class="section"><a href="ch-upgrading.zh_CN.html#minimal-upgrade">4.5.6. 最小系统升级</a></span></dt><dt><span class="section"><a href="ch-upgrading.zh_CN.html#upgrading-kernel">4.5.7. 升级内核</a></span></dt><dt><span class="section"><a href="ch-upgrading.zh_CN.html#upgrading-other">4.5.8. 升级系统的其它部分</a></span></dt><dt><span class="section"><a href="ch-upgrading.zh_CN.html#get-signatures">4.5.9. 取得包签名</a></span></dt><dt><span class="section"><a href="ch-upgrading.zh_CN.html#trouble">4.5.10. 升级期间可能遇到的问题</a></span></dt></dl></dd><dt><span class="section"><a href="ch-upgrading.zh_CN.html#newkernel">4.6. 升级内核与相关包</a></span></dt><dd><dl><dt><span class="section"><a href="ch-upgrading.zh_CN.html#kernel-metapackage">4.6.1. 安装内核元数据包</a></span></dt><dt><span class="section"><a href="ch-upgrading.zh_CN.html#upgrade-from-2.6">4.6.2. 从 2.6 内核升级</a></span></dt><dt><span class="section"><a href="ch-upgrading.zh_CN.html#upgrade-from-2.4">4.6.3. 从 2.4 内核升级</a></span></dt><dt><span class="section"><a href="ch-upgrading.zh_CN.html#device-reorder">4.6.4. 设备枚举的顺序</a></span></dt><dt><span class="section"><a href="ch-upgrading.zh_CN.html#boot-timing">4.6.5. 引导期间的问题</a></span></dt></dl></dd><dt><span class="section"><a href="ch-upgrading.zh_CN.html#nownownow">4.7. 在重启之前要做的事情</a></span></dt><dd><dl><dt><span class="section"><a href="ch-upgrading.zh_CN.html#rerunlilo">4.7.1. 重新运行 lilo</a></span></dt><dt><span class="section"><a href="ch-upgrading.zh_CN.html#mdadm">4.7.2. 升级 mdadm</a></span></dt></dl></dd><dt><span class="section"><a href="ch-upgrading.zh_CN.html#boot-hangs">4.8. 系统引导时在显示 <code class="literal">Waiting for root file system</code> 后挂起</a></span></dt><dd><dl><dt><span class="section"><a href="ch-upgrading.zh_CN.html#avoid-problems-before-upgrading">4.8.1. 如何在升级前避免此问题</a></span></dt><dt><span class="section"><a href="ch-upgrading.zh_CN.html#how-to-recover">4.8.2. 如何在升级后解决此问题</a></span></dt></dl></dd><dt><span class="section"><a href="ch-upgrading.zh_CN.html#for-next">4.9. 为下个发行版做准备</a></span></dt><dt><span class="section"><a href="ch-upgrading.zh_CN.html#deprecated">4.10. 不赞成地包</a></span></dt><dt><span class="section"><a href="ch-upgrading.zh_CN.html#obsolete">4.11. 过时的包</a></span></dt><dd><dl><dt><span class="section"><a href="ch-upgrading.zh_CN.html#dummy">4.11.1. 哑包</a></span></dt></dl></dd><dt><span class="section"><a href="ch-upgrading.zh_CN.html#plans-for-nigel">4.12. 下个 Debian 发行版的计划</a></span></dt></dl></div><div class="section" lang="zh-CN" xml:lang="zh-CN"><div class="titlepage"><div><div><h2 class="title" style="clear: both"><a id="backup"></a>4.1. 升级前的准备</h2></div></div></div><p>
我们建议您在升级前阅读<a class="xref" href="ch-information.zh_CN.html" title="第 5 章 lenny 中需要注意的问题">第 5 章 <i>lenny 中需要注意的问题</i></a>
中的信息。那一章含有潜在的与升级过程间接相关的问题，但在开始升级前了解这些信息对您还是很重要的。
</p><div class="section" lang="zh-CN" xml:lang="zh-CN"><div class="titlepage"><div><div><h3 class="title"><a id="data-backup"></a>4.1.1. 备份数据和配置文件</h3></div></div></div><p>
在升级系统前，强烈建议你进行一次完整的备份，或者至少备份你不愿意丢失的数据和配置信息。升级工具和流程是非常可信的，但升级过程中的硬件错误会对你的系统造成严重损害。
</p><p>
你需要备份的内容包括 <code class="filename">/etc</code>, <code class="filename">/var/lib/dpkg</code>,
<code class="filename">/var/lib/aptitude/pkgstates</code> 下的文件以及 <code class="literal">dpkg
--get-selections "*"</code> 的输出(命令行中的引号是必须的)。
</p><p>
升级过程本身不会修改 <code class="filename">/home</code> 下的任何内容。但某些程序 (比如部分 Mozilla 套件，以及 GNOME
和 KDE 桌面环境)
会在新版本程序第一次启动时用新的缺省值来覆盖现有的用户设置。做为预防，你也许希望备份用户目录下的隐藏文件和目录(“<span class="quote">dotfiles</span>”)。该备份有助于你恢复或者重新创建旧设置。另外，你还需把该事项通知给用户。
</p><p>
包安装过程需要超级用户权限，你可以用 root 登录, 使用 <span class="command"><strong>su</strong></span>, 或使用
<span class="command"><strong>sudo</strong></span> 来获取必要的权限。
</p><p>
升级需要几个条件，你应当在真正执行升级前检查这些条件。
</p></div><div class="section" lang="zh-CN" xml:lang="zh-CN"><div class="titlepage"><div><div><h3 class="title"><a id="inform-users"></a>4.1.2. 提前告知用户</h3></div></div></div><p>
提前通知所有用户您正在计划的任何升级将是明智的决定，即便通过 <span class="command"><strong>ssh</strong></span>
连接访问您系统的用户可能在升级过程中不会注意到什么，而且应该可以继续工作。
</p><p>
如果您希望采取更多的预防措施，请在升级前备份或者卸载用户的分区(<code class="filename">/home</code>)。
</p><p>
当升级到 lenny 时您将可能需要进行内核升级，所以通常需要重启。一般说来，这将在升级完成后进行。
</p></div><div class="section" lang="zh-CN" xml:lang="zh-CN"><div class="titlepage"><div><div><h3 class="title"><a id="recovery"></a>4.1.3. 准备恢复</h3></div></div></div><p>
由于 etch 和 lenny
的内核在驱动、硬件探测与命名以及设备文件的命名和顺序等方面有很多变化，在更新后您将可能会在重启系统时遇到很大的问题。本章和发行注记下一章记录了很多已知的潜在问题。
</p><p>
由于这个原因最好确保，如果您的系统重启失败，或者对于远程管理的系统，无法唤醒网络时，您能够将其恢复。
</p><p>
如果你通过 <span class="command"><strong>ssh</strong></span>
远程连接进行升级，则强烈建议您采取必要的预防措施以能够通过远程串行终端来访问该服务器。因为在升级内核并重启后，有些设备有可能会被改名(如在 <a class="xref" href="ch-upgrading.zh_CN.html#device-reorder" title="4.6.4. 设备枚举的顺序">第 4.6.4 节 “设备枚举的顺序”</a>
中所描述的情况)而且您将需要通过本地控制台修复系统配置。而且，如果系统在升级过程中意外重启您将可能需要使用本地终端进行修复。
</p><p>
很明显首先要做的就是重启到您的旧内核。然而，由于本文档其他地方记录的各种各样的问题，这并不保证成功。
</p><p>
如果失败了，您将需要采取替代方案来启动您的系统以便访问和修复她。一个选择是使用特制的急救盘或者 Linux live
CD。从这些介质重启后，您应该可以挂载您的根文件系统并 <code class="literal">chroot</code> 到它里面来检查并修复问题。
</p><p>
我们推荐的另一个选择是使用 lenny Debian 安装程序的
<span class="emphasis"><em>拯救模式</em></span>。使用安装程序的优点是您可以从它的很多安装方法中选择最适合您情况的一种。更多信息请查询 <a class="ulink" href="http://www.debian.org/releases/stable/installmanual" target="_top">安装手册</a> 第8章的 “<span class="quote">修复损坏的系统</span>” 小节以及
<a class="ulink" href="http://wiki.debian.org/DebianInstaller/FAQ" target="_top">Debian Installer FAQ</a>。
</p><div class="section" lang="zh-CN" xml:lang="zh-CN"><div class="titlepage"><div><div><h4 class="title"><a id="recovery-initrd"></a>4.1.3.1. initrd 引导时使用调试环境</h4></div></div></div><p>
<code class="systemitem">initramfs-tools</code> 在其生成的 initrd 中包含一个调试
shell<sup>[<a id="id545891" href="#ftn.id545891" class="footnote">3</a>]</sup>假如 initrd 无法挂载您的根文件系统，您将会进入此调试 shell，里面可以使用基本的命令以帮助跟踪问题甚至有可能解决之。
</p><p>
需要检查的几个基本项目：<code class="filename">/dev</code> 下是否存在正确的设备文件；加载了什么模块(<code class="literal">cat
/proc/modules</code>)；<span class="command"><strong>dmesg</strong></span>
的输出中有关驱动加载的错误信息。<span class="command"><strong>dmesg</strong></span> 的输出还会显式哪个设备文件被指定给哪个磁盘；您需要检查
<code class="literal">echo $ROOT</code> 的输出以确保根文件系统在预想的设备上。
</p><p>
如果您确实打算修复错误，输入 <code class="literal">exit</code>
会退出调试环境并从这一失败点开始继续启动过程。当然，您也需要修复后续的错误并重新生成 initrd
，这样下一次启动时就不会再失败了。如果您确实修复了问题，键入 <code class="literal">exit</code> 会退出调试 shell
并从先前失败的地方继续启动进程。当然您还需要修复先前的问题并重新生成 initrd 以使下次启动不再失败。
</p></div></div><div class="section" lang="zh-CN" xml:lang="zh-CN"><div class="titlepage"><div><div><h3 class="title"><a id="upgrade-preparations"></a>4.1.4. 为升级准备安全环境</h3></div></div></div><p>
发行版升级应该在本地从文本模式虚拟终端(或者直连串行终端)，或者通过 <span class="command"><strong>ssh</strong></span> 远程连接进行。
</p><p>
为了在远程升级时获得额外的可靠性保障，我们建议您在由 <span class="command"><strong>screen</strong></span>
程序生成的虚拟控制台中执行升级过程。它能进行可靠的重新连接并确保，即使远程连接失败，升级过程也不会被打断
</p><div class="important" style="margin-left: 0.5in; margin-right: 0.5in;"><table border="0" summary="Important"><tr><td rowspan="2" align="center" valign="top" width="25"><img alt="[重要]" src="images/important.png" /></td><th align="left">重要</th></tr><tr><td align="left" valign="top"><p>
    您<span class="emphasis"><em>不应该</em></span>在您要升级的机器上使用
<span class="command"><strong>telnet</strong></span>、<span class="command"><strong>rlogin</strong></span>、<span class="command"><strong>rsh</strong></span>
之类的东西，或者从
<span class="command"><strong>xdm</strong></span>、<span class="command"><strong>gdm</strong></span>、<span class="command"><strong>kdm</strong></span> 之类管理的 X
会话中升级。因为那些服务中的任意一个在升级中都有可能被中止，进而导致出现一个<span class="emphasis"><em>不可访问</em></span>的只升级了一半的系统。
  </p></td></tr></table></div></div><div class="section" lang="zh-CN" xml:lang="zh-CN"><div class="titlepage"><div><div><h3 class="title"><a id="prepare-initramfs"></a>4.1.5. 为 <acronym title="Linux 加载器">LILO</acronym><a id="id546065" class="indexterm"></a> 准备
initramfs</h3></div></div></div><p>
    使用 <acronym title="Linux 加载器">LILO</acronym> 启动管理器的用户应该注意，<code class="systemitem">initramfs-tools</code> 的默认设置目前生成的 initramfs 对于
<acronym title="Linux 加载器">LILO</acronym> 来说太大而无法加载。那样的用户要么把启动管理器换成 <code class="systemitem">grub</code>，要么就编辑
<code class="filename">/etc/initramfs-tools/initramfs.conf</code> 文件，更改这行 </p><pre class="programlisting">MODULES=most</pre><p> 为
    </p><pre class="programlisting">MODULES=dep</pre><p>
    但是请注意，这么做会引起 <code class="systemitem">initramfs-tools</code>
仅安装那些它运行所需特定硬件的模块至
initramfs；如此说来，如果您想生成一个引导介质，它可以在更多的硬件上工作，而不是只在与您相同硬件的机器工作时，您应该保存设置为
    </p><pre class="programlisting">MODULES=most</pre><p> 并保证不使用 <acronym title="Linux 加载器">LILO</acronym>。
  </p></div></div><div class="section" lang="zh-CN" xml:lang="zh-CN"><div class="titlepage"><div><div><h2 class="title" style="clear: both"><a id="system-status"></a>4.2. 检查系统状态</h2></div></div></div><p>
此章所述的升级过程是按从“<span class="quote">纯粹的</span>” etch
升级而安排的；系统中没有第三方的包。为得到最可靠的升级过程，您可能会希望在升级前，从系统中移除第三方的软件包。
</p><p>
此过程也假定您的系统已经更新至 etch 的最新发行点。如果您还未做或是不确定，请按 <a class="xref" href="ap-old-stuff.zh_CN.html#old-upgrade" title="A.1. 升级您的 etch 系统">第 A.1 节 “升级您的 etch 系统”</a> 中的说明做。
</p><div class="section" lang="zh-CN" xml:lang="zh-CN"><div class="titlepage"><div><div><h3 class="title"><a id="review-actions"></a>4.2.1. 复审包管理器中未决的的操作</h3></div></div></div><p>
在某些情况下，使用 <span class="command"><strong>apt-get</strong></span> 代替 <span class="command"><strong>aptitude</strong></span>
安装软件包时可能会让 <span class="command"><strong>aptitude</strong></span>
认为包“<span class="quote">未被使用</span>”并安排它被移除。一般来说，在正式升级前您应该确保系统是最新的，且“<span class="quote">干净的</span>”。
</p><p>
有鉴于此，您应该复查包管理器 <span class="command"><strong>aptitude</strong></span>
中是否有未决操作。如果包管理器中有包被安排为移除或更新，那么这可能对升级过程有负面影响。注意，改正这一错误的唯一可能性就是，您仍然在
<code class="filename">sources.list</code> 中指向
<span class="emphasis"><em>etch</em></span>，而非 <span class="emphasis"><em>stable</em></span> 或是
<span class="emphasis"><em>lenny</em></span>。参看<a class="xref" href="ap-old-stuff.zh_CN.html#old-sources" title="A.2. 检查您的 sources list">第 A.2 节 “检查您的 sources list”</a>。
</p><p>
要复查的话，您必须以“<span class="quote">图形模式</span>”运行 <span class="command"><strong>aptitude</strong></span> 并按下
<span class="keycap"><strong>g</strong></span>（“<span class="quote">Go</span>”）。如果显示有任何未决操作，您都应该复查它们，然后要么修复，要么执行建议的操作。如果没有建议的操作，会有一条信息说
“<span class="quote">No package are scheduled to be installed, removed, or ugraded</span>”
出现。
</p></div><div class="section" lang="zh-CN" xml:lang="zh-CN"><div class="titlepage"><div><div><h3 class="title"><a id="disable-apt-pinning"></a>4.2.2. 禁用 APT pinning 操作</h3></div></div></div><p>
如果已经设置 APT 从一个非 stable （如 testing）版安装特定包，您可能必须改变 APT pinning 设置（保存在
<code class="filename">/etc/apt/preferences</code> 中）以允许升级至新的 stable 版中的包。更多有关 APT
pinning 的信息可以在<span class="citerefentry"><span class="refentrytitle">apt_preferences</span>(5)</span> 中找到。
</p></div><div class="section" lang="zh-CN" xml:lang="zh-CN"><div class="titlepage"><div><div><h3 class="title"><a id="package-status"></a>4.2.3. 检查包状态</h3></div></div></div><p>
不管用什么方法升级，我们都建议您先检查所有包的状态，并验证所有包都处于可升级状态。以下命令会显示任何半安装或是配置失败的包，还有那些有任何错误状态的包。
</p><pre class="screen">
# dpkg --audit
</pre><p>
您也可以用 <span class="command"><strong>dselect</strong></span>、<span class="command"><strong>aptitude</strong></span>
来审查系统中的所有包的状态，也可以用如下的命令来审查
</p><pre class="screen">
# dpkg -l | pager
</pre><p>
或是
</p><pre class="screen">
# dpkg --get-selections "*" &gt; ~/curr-pkgs.txt
</pre><p>
在升级前移除所有的 hold 状态是很有必要的。如果有任何对升级而言有重要意义的包处于 hold 状态，升级会失败。
</p><p>
注意 <span class="command"><strong>aptitude</strong></span> 使用一种与 <span class="command"><strong>apt-get</strong></span> 及
<span class="command"><strong>dselect</strong></span> 不同的方法来注册 hold 状态的包。您可以用以下命令来确认
<span class="command"><strong>aptitude</strong></span> 中处于 hold 状态的包。
</p><pre class="screen">
# aptitude search "~ahold" | grep "^.h"
</pre><p>
如果您想检查 <span class="command"><strong>apt-get</strong></span> 中哪些包设置了 hold 状态，可以用
</p><pre class="screen">
# dpkg --get-selections | grep hold
</pre><p>
如果您在本地更改并重编译了一个包，且并未重命名或是在版本号中放入新的纪元号，您就必须将它设为 hold 状态以防止它升级。
</p><p>
<span class="command"><strong>aptitude</strong></span> 中的 “<span class="quote">hold</span>” 状态的包能用以下命令更改：
</p><pre class="screen">
# aptitude hold <em class="replaceable"><code>package_name</code></em>
</pre><p>
用 <code class="literal">unhold</code> 代替 <code class="literal">hold</code> 可清除
“<span class="quote">hold</span>” 状态。
</p><p>
如果有任何需要更正的东西，您最好确保 <code class="filename">sources.list</code> 仍然指向 etch
，就像<a class="xref" href="ap-old-stuff.zh_CN.html#old-sources" title="A.2. 检查您的 sources list">第 A.2 节 “检查您的 sources list”</a>中所说的那样。
</p></div><div class="section" lang="zh-CN" xml:lang="zh-CN"><div class="titlepage"><div><div><h3 class="title"><a id="userbackports"></a>4.2.4. 非官方源和 backports</h3></div></div></div><p>
如果有任何非 Debian 的包装于您的系统，您应该意识到它们可能会在升级期间因为依赖性冲突而被移除。如果这些包是通过在
<code class="filename">/etc/apt/source.list</code> 中添加一个额外的软件源而安装的，您应该检查那个软件源是否也提供
lenny 下编译好的包并同时像您的 Debian 软件源那样更改相应的源。
</p><p>
某些用户可能有非官方的 backported “<span class="quote">较新的</span>” 包版本<span class="emphasis"><em>存在</em></span>于他们安装的
Debian etch 系统中。升级期间那样的包是最可能引起问题的，因为它们可能会导致文件冲突<sup>[<a id="id546524" href="#ftn.id546524" class="footnote">4</a>]</sup>。<a class="xref" href="ch-upgrading.zh_CN.html#trouble" title="4.5.10. 升级期间可能遇到的问题">第 4.5.10 节 “升级期间可能遇到的问题”</a> 已经有一些关于如何处理将会出现的文件冲突的信息了。
</p></div></div><div class="section" lang="zh-CN" xml:lang="zh-CN"><div class="titlepage"><div><div><h2 class="title" style="clear: both"><a id="handle-conflict"></a>4.3. 手工删除包标记</h2></div></div></div><p>
要防止 <span class="command"><strong>aptitude</strong></span> 移除某些因依赖关系而安装的包，您需要手工删除它们这些包上的
<span class="emphasis"><em>auto</em></span> 标记。对于桌面安装来说，包括有 OpenOffice 和 Vim：
</p><pre class="screen">
# aptitude unmarkauto openoffice.org vim
</pre><p>
如果您已经用内核元数据包安装了 2.6 内核镜像，那还要包括它：
</p><pre class="screen">
# aptitude unmarkauto $(dpkg-query -W 'kernel-image-2.6.*' | cut -f1)
</pre><div class="note" style="margin-left: 0.5in; margin-right: 0.5in;"><table border="0" summary="Note"><tr><td rowspan="2" align="center" valign="top" width="25"><img alt="[注意]" src="images/note.png" /></td><th align="left">注意</th></tr><tr><td align="left" valign="top"><p>
    您可以复查那些在 aptitude 中被标记为 <span class="emphasis"><em>auto</em></span> 的包，执行：
  </p><pre class="screen"># aptitude search 'i~M <em class="replaceable"><code>package_name</code></em>'</pre></td></tr></table></div></div><div class="section" lang="zh-CN" xml:lang="zh-CN"><div class="titlepage"><div><div><h2 class="title" style="clear: both"><a id="upgrade-process"></a>4.4. 为 APT 准备源</h2></div></div></div><p>
在开始升级前，您必须在源列表 <code class="filename">/etc/apt/sources.list</code> 中设定 <code class="systemitem">apt</code> 的配置文件。
</p><p>
<code class="systemitem">apt</code> 会照顾到所有通过任意
“<span class="quote"><code class="literal">deb</code></span>”
行找到的包，并安装带最高版本号的包，给于第一个引用到的行以优先权（那样，如果有多个镜像地址，您最好先命名本地硬盘，然后是 CD-ROM，最后是
HTTP/FTP 镜像）。
</p><p>
一个发行版通常既能通过它的代码名（如：<code class="literal">etch</code>,
<code class="literal">lenny</code>）引用，也可以用它的状态名引用（如：<code class="literal">oldstable</code>,
<code class="literal">stable</code>, <code class="literal">testing</code>,
<code class="literal">unstable</code>）。引用发行版的代码名的好处在于，您绝对不会被新发行版问题困扰且被带至此处。当然，这绝对意味着您不得不自己关注新发行版的发行。如果转而使用状态名，如果有新版发行，您将只会看到一堆可用的软件包的更新。
</p><div class="section" lang="zh-CN" xml:lang="zh-CN"><div class="titlepage"><div><div><h3 class="title"><a id="network"></a>4.4.1. 添加互联网 APT 源</h3></div></div></div><p>
默认配置用于从主 Debian 网络服务器上安装，但您可能希望修改 <code class="filename">/etc/apt/sources.list</code>
以使用其它的镜像，离您最近的网络镜像是一个更佳的选择。
</p><p>
Debian HTTP 或 FTP 镜像地址能在 <a class="ulink" href="http://www.debian.org/distrib/ftplist" target="_top">http://www.debian.org/distrib/ftplist</a>
找到（参看“<span class="quote"> Debian 镜像列表</span>”一节）。HTTP 镜像通常比 FTP 镜像快。
</p><p>
例如，假设离您最近的 Debian 镜像是 <code class="literal">http://mirrors.kernel.org/debian</code>。当用网络浏览器或是
FTP 程序检查那个镜像时，您会注意到主目录组织成了如下情况：
</p><pre class="screen">
http://mirrors.kernel.org/debian/dists/lenny/main/binary-i386/...
http://mirrors.kernel.org/debian/dists/lenny/contrib/binary-i386/...
</pre><p>
要让 <code class="systemitem">apt</code> 使用这个镜像，您将此行添加至
<code class="filename">sources.list</code> 文件：
</p><pre class="screen">
deb http://mirrors.kernel.org/debian lenny main contrib
</pre><p>
注意明显加上去的‘<code class="literal">dists</code>’，这个发行版名字后的参数被用于将路径扩展成多个目录。
</p><p>
添加新源后，在 <code class="filename">sources.list</code> 中通过在以前存在的
“<span class="quote"><code class="literal">deb</code></span>” 行前加上一个井号（<code class="literal">#</code>）来禁用它们。
</p></div><div class="section" lang="zh-CN" xml:lang="zh-CN"><div class="titlepage"><div><div><h3 class="title"><a id="localmirror"></a>4.4.2. 添加本地镜像 APT 源</h3></div></div></div><p>
不用 HTTP 或 FTP 包镜像，您可能希望修改 <code class="filename">/etc/apt/sources.list</code>
来使用一个本地磁盘上的镜像（也许是通过 <acronym title="网络文件系统">NFS</acronym> 挂载的
</p><p>
例如，假设您的包镜像位于 <code class="filename">/var/ftp/devian/</code> 下，并且有如下的主目录：
</p><pre class="screen">
/var/ftp/debian/dists/lenny/main/binary-i386/...
/var/ftp/debian/dists/lenny/contrib/binary-i386/...
</pre><p>
要让 <code class="systemitem">apt</code> 使用它，就把这一行添加至
<code class="filename">sources.list</code> 文件：
</p><pre class="screen">
deb file:/var/ftp/debian lenny main contrib
</pre><p>
注意明显加上去的‘<code class="literal">dists</code>’，这个发行版名字后的参数被用于将路径扩展成多个目录。
</p><p>
添加新源后，在 <code class="filename">sources.list</code> 中通过在以前存在的
“<span class="quote"><code class="literal">deb</code></span>” 行前加上一个井号（<code class="literal">#</code>）来禁用它们。
</p></div><div class="section" lang="zh-CN" xml:lang="zh-CN"><div class="titlepage"><div><div><h3 class="title"><a id="cdroms"></a>4.4.3. 从 CD-ROM 或 DVD 添加 APT 源</h3></div></div></div><p>
如果您<span class="emphasis"><em>只</em></span>想用 CD 安装，在
<code class="filename">/etc/apt/sources.list</code> 中的
“<span class="quote"><code class="literal">deb</code></span>” 行前放上井号（<code class="literal">#</code>）注释掉它们。
</p><p>
确保在 <code class="filename">/etc/fstab</code> 中有一行允许挂载您的 CD-ROM 于
<code class="filename">/cdrom</code> 挂载点（<span class="command"><strong>apt-cdrom</strong></span> 需要准确的
<code class="filename">/cdrom</code> 挂载点）。例如，假设 <code class="filename">/dev/hdc</code> 就是您的
CD-ROM，<code class="filename">/etc/fstab</code> 中应该带有一行：
</p><pre class="screen">
/dev/hdc /cdrom auto defaults,noauto,ro 0 0
</pre><p>
注意在第四段 <code class="literal">defaults,noauto,ro</code> 之间不允许有<span class="emphasis"><em>空格</em></span>。
</p><p>
要验证它是否能正确工作，插入一片 CD 并试着运行
</p><pre class="screen">
# mount /cdrom    # 挂载 CD 至挂载点
# ls -alF /cdrom  # 显示 CD 的根目录
# umount /cdrom   # 卸载 CD
</pre><p>
下一步，运行：
</p><pre class="screen">
# apt-cdrom add
</pre><p>
每一片您所拥有的 Debian 二进制 CD-ROM 都要这么做，以便将每片 CD 的数据添加至 APT 的数据库。
</p></div></div><div class="section" lang="zh-CN" xml:lang="zh-CN"><div class="titlepage"><div><div><h2 class="title" style="clear: both"><a id="upgradingpackages"></a>4.5. 升级包</h2></div></div></div><p>
推荐的从以前 Debian <acronym title="GNU's Not Unix 的递归缩写">GNU</acronym>/Linux 发行版升级的方法是使用包管理器 <span class="command"><strong>aptitude</strong></span>。此程序会对安装包采取比直接运行
<span class="command"><strong>apt-get</strong></span> 更保守的选择。
</p><p>
不要忘记挂载所有必需的分区（尤其是根分区和 <code class="filename">/usr</code> 分区）为可读写状态，用以下命令：
</p><pre class="screen">
# mount -o remount,rw /<em class="replaceable"><code>mountpoint</code></em>
</pre><p>
下一步您应该详细检查 APT 源记录（<code class="filename">/etc/apt/source.list</code>）要么指向
“<span class="quote"><code class="literal">lenny</code></span>” 又或指向
“<span class="quote"><code class="literal">stable</code></span>”。不应该有任何指向 etch 的源记录。
</p><div class="note" style="margin-left: 0.5in; margin-right: 0.5in;"><table border="0" summary="Note"><tr><td rowspan="2" align="center" valign="top" width="25"><img alt="[注意]" src="images/note.png" /></td><th align="left">注意</th></tr><tr><td align="left" valign="top"><p>
    CD-ROM 的源通常会指向
“<span class="quote"><code class="literal">unstable</code></span>”。尽管这令人困惑，但您<span class="emphasis"><em>不应该</em></span>改变它。
  </p></td></tr></table></div><p>
</p><div class="section" lang="zh-CN" xml:lang="zh-CN"><div class="titlepage"><div><div><h3 class="title"><a id="record-session"></a>4.5.1. 记录会话</h3></div></div></div><p>
强烈推荐您使用 <span class="command"><strong>/usr/bin/script</strong></span>
程序来记录升级会话中的交互信息。这样如果有问题了，您就有一份问题报告。而且如果需要的话，您也可以在错误报告中提供额外信息。要开始记录，输入：
</p><pre class="screen">
# script -t 2&gt;~/upgrade-lenny.time -a ~/upgrade-lenny.script
</pre><p>
或是类似命令。不要将输出文件放在临时目录下，如 <code class="filename">/tmp</code> 或
<code class="filename">/var/tmp</code>（这些目录下的文件可能会在升级时或重启时被删除）
</p><p>
输出文件也可让您复查屏幕上滚动过去的信息。只要切换至虚拟终端 2（使用 <span class="keycap"><strong>Alt</strong></span>+<span class="keycap"><strong>F2</strong></span>），在登入后，用
<code class="literal">less -R ~root/upgrade-lenny.script</code> 查看文件。
</p><p>
在完成升级后，您可以在提示符下输入 <code class="literal">exit</code> 停止 <span class="command"><strong>script</strong></span>。
</p><p>
如果已经对 <span class="command"><strong>script</strong></span> 使用了 <span class="emphasis"><em>-t</em></span> 选项，您就可以用
<span class="command"><strong>scriptplay</strong></span> 程序来回放整个过程：
</p><pre class="screen">
# scriptreplay ~/upgrade-lenny.time ~/upgrade-lenny.script
</pre></div><div class="section" lang="zh-CN" xml:lang="zh-CN"><div class="titlepage"><div><div><h3 class="title"><a id="updating-lists"></a>4.5.2. 更新包列表</h3></div></div></div><p>
首先，需要获取新发行版的可用包列表。执行：
</p><pre class="screen">
# aptitude update
</pre><p>
首次执行这个对新源进行更新会打印出一些有关源可用性的警告信息。这些警告没关系而且在您下一次执行时就没有了。
</p></div><div class="section" lang="zh-CN" xml:lang="zh-CN"><div class="titlepage"><div><div><h3 class="title"><a id="sufficient-space"></a>4.5.3. 确保你有足够的空间升级</h3></div></div></div><p>
在升级系统前必须确保在进行如???中所述的完全系统升级时，您有足够的磁盘空间。首先，安装所需的任何从网络上取回的包都被保存在
<code class="filename">/var/cache/apt/archives</code>（下载期间还会放在
<code class="filename">partial/</code> 子目录下），因此您必须确保在文件系统分区
<code class="filename">/var/</code>
下有足够的空间，以便临时下载将会安装在系统中的包。下载之后，您可能在其它文件系统分区中需要更多的空间来同时安装升级包（可能会包含更大的二进制程序或更多数据）和升级中带入的新包。如果系统中没有足够的空间，您可能以一个未完成的升级结束，而这可能难以恢复。
</p><p>
<span class="command"><strong>aptitude</strong></span> 和 <code class="systemitem">apt</code>
都会给你显示安装所需磁盘空间的详细信息。在执行升级操作前，您可以运行以下命令来看到这个估计值：
</p><pre class="screen">
# aptitude -y -s -f --with-recommends dist-upgrade
[ ... ]
XXX 个已升级，XXX 个刚装上，XXX 个待删除以及 XXX 个未升级。
需要获取 xx.xMB/yyyMB。解开后，将占用 AAAMB。
会下载/安装/删除包。
</pre><p>
<sup>[<a id="id547504" href="#ftn.id547504" class="footnote">5</a>]</sup>
</p><p>
如果没有足够空间来升级，确保您预先释放了空间。可以这样：
</p><div class="itemizedlist"><ul type="disc"><li><p>
删除以前安装时下载的包（位于 <code class="filename">/var/cache/apt/archive</code>）。用
<span class="command"><strong>apt-get clean</strong></span> 或是 <span class="command"><strong>aptitude clean</strong></span>
来清理包缓存，这会删除所有以前下载过的包文件。
</p></li><li><p>
删除您从来不用的旧包。如果您安装过 <code class="systemitem">popularity-contest</code>，可以用
<span class="command"><strong>popcon-largest-unused</strong></span> 来列出系统中占用大量空间而又不用的那些包。您也可以用
<span class="command"><strong>deborphan</strong></span> 或是 <span class="command"><strong>debfoster</strong></span> 来找出过时的包（参看<a class="xref" href="ch-upgrading.zh_CN.html#obsolete" title="4.11. 过时的包">第 4.11 节 “过时的包”</a>）。另一可选方案您可以“<span class="quote">图形模式</span>”运行
<span class="command"><strong>aptitude</strong></span> 在 “<span class="quote">Obsolete and Locally Created
Packages</span>” 下找到过时的包。
</p></li><li><p>
删除占用太多空间，目前不需要的包（您总是可以在升级后重装它们的）。您可以用 <span class="command"><strong>dpigs</strong></span>（可在
<code class="systemitem">debian-goodies</code> 包中找到）或是用
<span class="command"><strong>wajig</strong></span>（运行 <code class="literal">wajig size</code>）列出占用大量空间的包。
</p></li><li><p>
Temporarily move to another system, or permanently remove, system logs
residing under <code class="filename">/var/log/</code>.
</p></li></ul></div><p>
Note that in order to safely remove packages, it is advisable to switch your
<code class="filename">sources.list</code> back to etch as described in
<a class="xref" href="ap-old-stuff.zh_CN.html#old-sources" title="A.2. 检查您的 sources list">第 A.2 节 “检查您的 sources list”</a>.
</p></div><div class="section" lang="zh-CN" xml:lang="zh-CN"><div class="titlepage"><div><div><h3 class="title"><a id="aptupgrade1st"></a>4.5.4. 先升级 apt 和/或 aptitude</h3></div></div></div><p>
    Several bug reports have shown that the versions of the <code class="systemitem">aptitude</code> and <code class="systemitem">apt</code> packages in etch are often unable to handle
the upgrade to lenny. In lenny, <code class="systemitem">apt</code> better deals with complex chains of packages
requiring immediate configuration and <code class="systemitem">aptitude</code> is smarter in searching solutions for
satisfying the dependencies. As these two features are heavily involved
during the dist-upgrade to lenny, it is then required to upgrade
those two packages before upgrading anything else. For <code class="systemitem">apt</code>, run:
    </p><pre class="programlisting"># apt-get install apt</pre><p>
    and for <code class="systemitem">aptitude</code> (if you have it
installed) run:
    </p><pre class="programlisting"># aptitude install aptitude</pre><p>
  </p><p>
    This step will automatically upgrade <code class="systemitem">libc6</code> and <code class="systemitem">locales</code> and will pull in SELinux support
libraries (<code class="systemitem">libselinux1</code>).  At this
point, some running services will be restarted, including
<span class="command"><strong>xdm</strong></span>, <span class="command"><strong>gdm</strong></span> and <span class="command"><strong>kdm</strong></span>.
As a consequence, local X11 sessions might be disconnected.
  </p></div><div class="section" lang="zh-CN" xml:lang="zh-CN"><div class="titlepage"><div><div><h3 class="title"><a id="aptconvert"></a>4.5.5. 使用 aptitudes 记录的 apt 自动安装的软件包列表</h3></div></div></div><p>
    <code class="systemitem">aptitude</code> maintains a list of
packages that were installed automatically (for instance, as dependencies of
another package). In lenny, <code class="systemitem">apt</code> now has this feature as well.
  </p><p>
    The first time the lenny version of <code class="systemitem">aptitude</code> is run, it will read in its list of
automatically installed packages and convert it for use with the
lenny version of <code class="systemitem">apt</code>. If you
have <code class="systemitem">aptitude</code> installed, you should
at least issue one <code class="systemitem">aptitude</code> command
to do the conversion. One way to do this is by searching for a non-existent
package:
    </p><pre class="programlisting"># aptitude search "?false"</pre><p>
</p></div><div class="section" lang="zh-CN" xml:lang="zh-CN"><div class="titlepage"><div><div><h3 class="title"><a id="minimal-upgrade"></a>4.5.6. 最小系统升级</h3></div></div></div><p>
Because of certain necessary package conflicts between etch and
lenny, running <code class="literal">aptitude dist-upgrade</code> directly
will often remove large numbers of packages that you will want to keep.  We
therefore recommend a two-part upgrade process, first a minimal upgrade to
overcome these conflicts, then a full <code class="literal">dist-upgrade</code>.
</p><p>
First, run:
</p><pre class="screen">
# aptitude upgrade
</pre><p>
This has the effect of upgrading those packages which can be upgraded
without requiring any other packages to be removed or installed.
</p><p>
The next step will vary depending on the set of packages that you have
installed.  These release notes give general advice about which method
should be used, but if in doubt, it is recommended that you examine the
package removals proposed by each method before proceeding.
</p><p>
Some common packages that are expected to be removed include <code class="systemitem">base-config</code>, <code class="systemitem">hotplug</code>, <code class="systemitem">xlibs</code>, <code class="systemitem">netkit-inetd</code>, <code class="systemitem">python2.3</code>, <code class="systemitem">xfree86-common</code>, and <code class="systemitem">xserver-common</code>.  For a more complete list of
packages obsoleted in lenny, see <a class="xref" href="ch-upgrading.zh_CN.html#obsolete" title="4.11. 过时的包">第 4.11 节 “过时的包”</a>.
</p><div class="section" lang="zh-CN" xml:lang="zh-CN"><div class="titlepage"><div><div><h4 class="title"><a id="minimal-upgrade-desktop"></a>4.5.6.1. 升级桌面系统</h4></div></div></div><p>
This upgrade path has been verified to work on systems with the
etch <code class="literal">desktop</code> task installed.  It is probably
the method that will give the best results on systems with the
<code class="literal">desktop</code> task installed, or with the
<code class="literal">gnome</code> or <code class="literal">kde</code> packages installed.
</p><p>
It is probably <span class="emphasis"><em>not</em></span> the correct method to use if you do
not already have the <code class="systemitem">libfam0c102</code> and
<code class="systemitem">xlibmesa-glu</code> packages installed:
</p><pre class="screen">
# dpkg -l libfam0c102 | grep ^ii
# dpkg -l xlibmesa-glu | grep ^ii
</pre><p>
If you do have a full desktop system installed, run:
</p><pre class="screen">
# aptitude install libfam0 xlibmesa-glu
</pre></div><div class="section" lang="zh-CN" xml:lang="zh-CN"><div class="titlepage"><div><div><h4 class="title"><a id="minimal-upgrade-x-server"></a>4.5.6.2. 升级安装了部分 X 包的系统</h4></div></div></div><p>
Systems with some X packages installed, but not the full
<code class="literal">desktop</code> task, require a different method.  This method
applies in general to systems with <code class="systemitem">xfree86-common</code> installed, including some server
systems which have <code class="systemitem">tasksel</code> server
tasks installed as some of these tasks include graphical management tools.
It is likely the correct method to use on systems which run X, but do not
have the full <code class="literal">desktop</code> task installed.
</p><pre class="screen">
# dpkg -l xfree86-common | grep ^ii
</pre><p>
First, check whether you have the <code class="systemitem">libfam0c102</code> and <code class="systemitem">xlibmesa-glu</code> packages installed.
</p><pre class="screen">
# dpkg -l libfam0c102 | grep ^ii
# dpkg -l xlibmesa-glu | grep ^ii
</pre><p>
If you do not have <code class="systemitem">libfam0c102</code>
installed, do not include <code class="systemitem">libfam0</code> in
the following commandline.  If you do not have <code class="systemitem">xlibmesa-glu</code> installed, do not include it in the
following commandline.  <sup>[<a id="id548158" href="#ftn.id548158" class="footnote">6</a>]</sup>
</p><pre class="screen">
# aptitude install x11-common <em class="replaceable"><code>libfam0</code></em> <em class="replaceable"><code>xlibmesa-glu</code></em>
</pre><p>
Note that installing <code class="systemitem">libfam0</code> will
also install the File Alteration Monitor (<code class="systemitem">fam</code>) as well as the RPC portmapper (<code class="systemitem">portmap</code>) if not already available in your
system.  Both packages will enable a new network service in the system
although they can both be configured to be bound to the (internal) loopback
network device.
</p></div><div class="section" lang="zh-CN" xml:lang="zh-CN"><div class="titlepage"><div><div><h4 class="title"><a id="minimal-upgrade-server"></a>4.5.6.3. 升级没有 X 支持的系统</h4></div></div></div><p>
On a system with no X, no additional <code class="literal">aptitude install</code>
command should be required, and you can move on to the next step.
</p></div></div><div class="section" lang="zh-CN" xml:lang="zh-CN"><div class="titlepage"><div><div><h3 class="title"><a id="upgrading-kernel"></a>4.5.7. 升级内核</h3></div></div></div><p>
The <code class="systemitem">udev</code> version in lenny
does not support kernel versions earlier than 2.6.15 (which includes
etch 2.6.8 kernels), and the <code class="systemitem">udev</code> version in etch will not work
properly with the latest kernels.  In addition, installing the lenny
version of <code class="systemitem">udev</code> will force the
removal of <code class="systemitem">hotplug</code>, used by Linux
2.4 kernels.
</p><p>
As a consequence, the previous kernel package will probably not boot
properly after this upgrade.  Similarly, there is a time window during the
upgrade in which <code class="systemitem">udev</code> has been
upgraded but the latest kernel has not been installed.  If the system were
to be rebooted at this point, in the middle of the upgrade, it might not be
bootable because of drivers not being properly detected and loaded.  (See
<a class="xref" href="ch-upgrading.zh_CN.html#upgrade-preparations" title="4.1.4. 为升级准备安全环境">第 4.1.4 节 “为升级准备安全环境”</a> for recommendations on preparing for
this possibility if you are upgrading remotely.)
</p><p>
Unless your system has the <code class="literal">desktop</code> task installed, or
other packages that would cause an unacceptable number of package removals,
it is therefore recommended that you upgrade the kernel on its own at this
point.
</p><p>
To proceed with this kernel upgrade, run:
</p><pre class="screen">
# aptitude install linux-image-2.6-<em class="replaceable"><code>flavor</code></em>
</pre><p>
See <a class="xref" href="ch-upgrading.zh_CN.html#kernel-metapackage" title="4.6.1. 安装内核元数据包">第 4.6.1 节 “安装内核元数据包”</a> for help in determining which
flavor of kernel package you should install.
</p><p>
In the desktop case, it is unfortunately not possible to ensure the new
kernel package is installed immediately after the new <code class="systemitem">udev</code> is installed, so there is a window of
unknown length when your system will have no kernel installed with full
hotplug support.  See <a class="xref" href="ch-upgrading.zh_CN.html#newkernel" title="4.6. 升级内核与相关包">第 4.6 节 “升级内核与相关包”</a> for information on
configuring your system to not depend on hotplug for booting.
</p></div><div class="section" lang="zh-CN" xml:lang="zh-CN"><div class="titlepage"><div><div><h3 class="title"><a id="upgrading-other"></a>4.5.8. 升级系统的其它部分</h3></div></div></div><p>
You are now ready to continue with the main part of the upgrade.  Execute:
</p><pre class="screen">
# aptitude dist-upgrade
</pre><p>
This will perform a complete upgrade of the system, i.e.  install the newest
available versions of all packages, and resolve all possible dependency
changes between packages in different releases.  If necessary, it will
install some new packages (usually new library versions, or renamed
packages), and remove any conflicting obsoleted packages.
</p><p>
When upgrading from a set of CD-ROMs, you will be asked to insert specific
CDs at several points during the upgrade.  You might have to insert the same
CD multiple times; this is due to inter-related packages that have been
spread out over the CDs.
</p><p>
New versions of currently installed packages that cannot be upgraded without
changing the install status of another package will be left at their current
version (displayed as “<span class="quote">held back</span>”).  This can be resolved by
either using <span class="command"><strong>aptitude</strong></span> to choose these packages for
installation or by trying <code class="literal">aptitude -f install
<em class="replaceable"><code>package</code></em></code>.
</p></div><div class="section" lang="zh-CN" xml:lang="zh-CN"><div class="titlepage"><div><div><h3 class="title"><a id="get-signatures"></a>4.5.9. 取得包签名</h3></div></div></div><p>
After the upgrade, with the new version of <code class="systemitem">apt</code> you can now update your package information,
which will include the new package signature checking mechanism:
</p><pre class="screen">
# aptitude update
</pre><p>
The upgrade will have already retrieved and enabled the signing keys for
Debian's package archives.  If you add other (unofficial) package sources,
<code class="systemitem">apt</code> will print warnings related to
its inability to confirm that packages downloaded from them are legitimate
and have not been tampered with.  For more information please see <a class="xref" href="ch-whats-new.zh_CN.html#pkgmgmt" title="2.1.1. 包管理">第 2.1.1 节 “包管理”</a>.
</p><p>
You will notice that, since you are using the new version of <code class="systemitem">apt</code>, it will download package differences files
(<code class="literal">pdiff</code>) instead of the full package index list.  For more
information on this feature please read <a class="xref" href="ch-information.zh_CN.html#apt-pdiff" title="5.1.5. APT 软件包索引文件更新缓慢">第 5.1.5 节 “APT 软件包索引文件更新缓慢”</a>.
</p></div><div class="section" lang="zh-CN" xml:lang="zh-CN"><div class="titlepage"><div><div><h3 class="title"><a id="trouble"></a>4.5.10. 升级期间可能遇到的问题</h3></div></div></div><p>
If an operation using <span class="command"><strong>aptitude</strong></span>,
<span class="command"><strong>apt-get</strong></span>, or <span class="command"><strong>dpkg</strong></span> fails with the error
</p><pre class="screen">
E: Dynamic MMap ran out of room
</pre><p>
the default cache space is insufficient.  You can solve this by either
removing or commenting lines you don't need in
<code class="filename">/etc/apt/sources.list</code> or by increasing the cache size.
The cache size can be increased by setting
<code class="literal">APT::Cache-Limit</code> in
<code class="filename">/etc/apt/apt.conf</code>.  The following command will set it
to a value that should be sufficient for the upgrade:
</p><pre class="screen">
# echo 'APT::Cache-Limit "12500000";' &gt;&gt; /etc/apt/apt.conf
</pre><p>
This assumes that you do not yet have this variable set in that file.
</p><p>
Sometimes it's necessary to enable the
<code class="literal">APT::Force-LoopBreak</code> option in APT to be able to
temporarily remove an essential package due to a Conflicts/Pre-Depends
loop.  <span class="command"><strong>aptitude</strong></span> will alert you of this and abort the
upgrade.  You can work around that by specifying <code class="literal">-o
APT::Force-LoopBreak=1</code> option on <span class="command"><strong>aptitude</strong></span>
command line.
</p><p>
It is possible that a system's dependency structure can be so corrupt as to
require manual intervention.  Usually this means using
<span class="command"><strong>aptitude</strong></span> or
</p><pre class="screen">
# dpkg --remove <em class="replaceable"><code>package_name</code></em>
</pre><p>
to eliminate some of the offending packages, or
</p><pre class="screen">
# aptitude -f install
# dpkg --configure --pending
</pre><p>
In extreme cases you might have to force re-installation with a command like
</p><pre class="screen">
# dpkg --install <em class="replaceable"><code>/path/to/package_name.deb</code></em>
</pre><p>
File conflicts should not occur if you upgrade from a “<span class="quote">pure</span>”
etch system, but can occur if you have unofficial backports
installed.  A file conflict will result in an error like:
</p><pre class="screen">
Unpacking <em class="replaceable"><code>&lt;package-foo&gt;</code></em> (from <em class="replaceable"><code>&lt;package-foo-file&gt;</code></em>) ...
dpkg: error processing <em class="replaceable"><code>&lt;package-foo&gt;</code></em> (--install):
 trying to overwrite `<em class="replaceable"><code>&lt;some-file-name&gt;</code></em>',
 which is also in package <em class="replaceable"><code>&lt;package-bar&gt;</code></em>
dpkg-deb: subprocess paste killed by signal (Broken pipe)
 Errors were encountered while processing:
 <em class="replaceable"><code>&lt;package-foo&gt;</code></em>
</pre><p>
You can try to solve a file conflict by forcibly removing the package
mentioned on the <span class="emphasis"><em>last</em></span> line of the error message:
</p><pre class="screen">
# dpkg -r --force-depends <em class="replaceable"><code>package_name</code></em>
</pre><p>
After fixing things up, you should be able to resume the upgrade by
repeating the previously described <code class="literal">aptitude</code> commands.
</p><p>
During the upgrade, you will be asked questions regarding the configuration
or re-configuration of several packages.  When you are asked if any file in
the <code class="filename">/etc/init.d</code> or <code class="filename">/etc/terminfo</code>
directories, or the <code class="filename">/etc/manpath.config</code> file should be
replaced by the package maintainer's version, it's usually necessary to
answer `yes' to ensure system consistency.  You can always revert to the old
versions, since they will be saved with a <code class="literal">.dpkg-old</code>
extension.
</p><p>
If you're not sure what to do, write down the name of the package or file
and sort things out at a later time.  You can search in the typescript file
to review the information that was on the screen during the upgrade.
</p></div></div><div class="section" lang="zh-CN" xml:lang="zh-CN"><div class="titlepage"><div><div><h2 class="title" style="clear: both"><a id="newkernel"></a>4.6. 升级内核与相关包</h2></div></div></div><p>
This section explains how to upgrade your kernel and identifies potential
issues related to this upgrade.  You can either install one of the
<code class="systemitem">linux-image-*</code> packages provided by
Debian, or compile a customized kernel from source.
</p><p>
Note that a lot of information in this section is based on the assumption
that you will be using one of the modular Debian kernels, together with
<code class="systemitem">initramfs-tools</code> and <code class="systemitem">udev</code>.  If you choose to use a custom kernel that
does not require an initrd or if you use a different initrd generator, some
of the information may not be relevant for you.
</p><p>
Note also that if <code class="systemitem">udev</code> is
<span class="emphasis"><em>not</em></span> installed on your system, it is still possible to
use <code class="systemitem">hotplug</code> for hardware discovery.
</p><p>
If you are currently using a 2.4 kernel, you should also read <a class="xref" href="ch-information.zh_CN.html#upgrade-to-2.6" title="5.2. 升级到 2.6 内核">第 5.2 节 “升级到 2.6 内核”</a> carefully.
</p><div class="section" lang="zh-CN" xml:lang="zh-CN"><div class="titlepage"><div><div><h3 class="title"><a id="kernel-metapackage"></a>4.6.1. 安装内核元数据包</h3></div></div></div><p>
When you dist-upgrade from etch to lenny, it is strongly
recommended that you install a new linux-image-2.6-* metapackage.  This
package may be installed automatically by the dist-upgrade process.  You can
verify this by running:
</p><pre class="screen">
# dpkg -l "linux-image*" | grep ^ii
</pre><p>
If you do not see any output, then you will need to install a new
linux-image package by hand.  To see a list of available linux-image-2.6
metapackages, run:
</p><pre class="screen">
# apt-cache search linux-image-2.6- | grep -v transition
</pre><p>
If you are unsure about which package to select, run <code class="literal">uname
-r</code> and look for a package with a similar name.  For example, if
you see '<code class="literal">2.4.27-3-686</code>', it is recommended that you
install <code class="systemitem">linux-image-2.6-686</code>.  (Note
that the 386 flavor no longer exists; if you are currently using the 386
kernel flavor, you should install the 486 flavor instead.) You may also use
<span class="command"><strong>apt-cache</strong></span> to see a long description of each package in
order to help choose the best one available.  For example:
</p><pre class="screen">
# apt-cache show linux-image-2.6-686
</pre><p>
You should then use <code class="literal">aptitude install</code> to install it.  Once
this new kernel is installed you should reboot at the next available
opportunity to get the benefits provided by the new kernel version.
</p><p>
For the more adventurous there is an easy way to compile your own custom
kernel on Debian <acronym title="GNU's Not Unix 的递归缩写">GNU</acronym>/Linux.  Install the <code class="systemitem">kernel-package</code> tool and read the documentation
in <code class="filename">/usr/share/doc/kernel-package</code>.
</p></div><div class="section" lang="zh-CN" xml:lang="zh-CN"><div class="titlepage"><div><div><h3 class="title"><a id="upgrade-from-2.6"></a>4.6.2. 从 2.6 内核升级</h3></div></div></div><p>
If you are currently running a 2.6 series kernel from etch this
upgrade will take place automatically after you do a full upgrade of the
system packages (as described in <a class="xref" href="ch-upgrading.zh_CN.html#upgradingpackages" title="4.5. 升级包">第 4.5 节 “升级包”</a> ).
</p><p>
If possible, it is to your advantage to upgrade the kernel package
separately from the main <code class="literal">dist-upgrade</code> to reduce the
chances of a temporarily non-bootable system.  See <a class="xref" href="ch-upgrading.zh_CN.html#upgrading-kernel" title="4.5.7. 升级内核">第 4.5.7 节 “升级内核”</a> for a description of this process.  Note that
this should only be done after the minimal upgrade process described in
<a class="xref" href="ch-upgrading.zh_CN.html#minimal-upgrade" title="4.5.6. 最小系统升级">第 4.5.6 节 “最小系统升级”</a>.
</p><p>
You can also take this step if you are using your own custom kernel and want
to use the kernel available in lenny.  If your kernel version is not
supported by <code class="systemitem">udev</code> then it is
recommended that you upgrade after the minimal upgrade.  If your version is
supported by <code class="systemitem">udev</code> you can safely
wait until after the full system upgrade.
</p></div><div class="section" lang="zh-CN" xml:lang="zh-CN"><div class="titlepage"><div><div><h3 class="title"><a id="upgrade-from-2.4"></a>4.6.3. 从 2.4 内核升级</h3></div></div></div><p>
If you have a 2.4 kernel installed, and your system relies on <code class="systemitem">hotplug</code> for its hardware detection you should
first upgrade to a 2.6 series kernel from etch before attempting
the upgrade.  Make sure that the 2.6 series kernel boots your system and all
your hardware is properly detected before you perform the upgrade.  The
<code class="systemitem">hotplug</code> package is removed from the
system (in favor of <code class="systemitem">udev</code>) when you
do a full system upgrade.  If you do not do the kernel upgrade before this
your system might not boot up properly from this point on.  Once you have
done an upgrade to a 2.6 series kernel in etch you can do a
kernel upgrade as described in <a class="xref" href="ch-upgrading.zh_CN.html#upgrade-from-2.6" title="4.6.2. 从 2.6 内核升级">第 4.6.2 节 “从 2.6 内核升级”</a>.
</p><p>
If your system does not rely on <code class="systemitem">hotplug</code><sup>[<a id="id549015" href="#ftn.id549015" class="footnote">7</a>]</sup> you can delay the kernel upgrade to after you have done a full
system upgrade, as described in <a class="xref" href="ch-upgrading.zh_CN.html#upgrading-other" title="4.5.8. 升级系统的其它部分">第 4.5.8 节 “升级系统的其它部分”</a>.  Once
your system has been upgraded you can then do the following (changing the
kernel package name to the one most suited to your system by substituting
<code class="varname">flavor</code>):
</p><pre class="screen">
# aptitude install linux-image-2.6-<em class="replaceable"><code>flavor</code></em>
</pre></div><div class="section" lang="zh-CN" xml:lang="zh-CN"><div class="titlepage"><div><div><h3 class="title"><a id="device-reorder"></a>4.6.4. 设备枚举的顺序</h3></div></div></div><p>
lenny features a more robust mechanism for hardware discovery than
previous releases.  However, this may cause changes in the order devices are
discovered on your system, affecting the order in which device names are
assigned.  For example, if you have two network adapters that are associated
with two different drivers, the devices eth0 and eth1 refer to may be
swapped.  Please note that the new mechanism means that if you e.g.
exchange ethernet adapters in a running lenny system, the new
adapter will also get a new interface name.
</p><p>
For network devices, you can avoid this reordering by using <code class="systemitem">udev</code> rules, more specifically, through the
definitions at
<code class="filename">/etc/udev/rules.d/z25_persistent-net.rules</code><sup>[<a id="id549081" href="#ftn.id549081" class="footnote">8</a>]</sup>.  Alternatively you can use the <span class="command"><strong>ifrename</strong></span>
utility to bind physical devices to specific names at boot time.  See
<span class="citerefentry"><span class="refentrytitle">ifrename</span>(8)</span> and <span class="citerefentry"><span class="refentrytitle">iftab</span>(5)</span> for more information.  The two alternatives (<code class="systemitem">udev</code> and <span class="command"><strong>ifrename</strong></span>) should not
be used at the same time.
</p><p>
For storage devices, you can avoid this reordering by using <code class="systemitem">initramfs-tools</code> and configuring it to load
storage device driver modules in the same order they are currently loaded.
To do this, identify the order the storage modules on your system were
loaded by looking at the output of <span class="command"><strong>lsmod</strong></span>.
<span class="command"><strong>lsmod</strong></span> lists modules in the reverse order that they were
loaded in, i.e., the first module in the list was the last one loaded.  Note
that this will only work for devices which the kernel enumerates in a stable
order (like PCI devices).
</p><p>
However, removing and reloading modules after initial boot will affect this
order.  Also, your kernel may have some drivers linked statically, and these
names will not appear in the output of <span class="command"><strong>lsmod</strong></span>.  You may be
able to decipher these driver names and load order from looking at
<code class="filename">/var/log/kern.log</code>, or the output of
<span class="command"><strong>dmesg</strong></span>.
</p><p>
Add these module names to <code class="filename">/etc/initramfs-tools/modules</code>
in the order they should be loaded at boot time.  Some module names may have
changed between etch and lenny.  For example,
sym53c8xx_2 has become sym53c8xx.
</p><p>
You will then need to regenerate your initramfs image(s) by executing
<code class="literal">update-initramfs -u -k all</code>.
</p><p>
Once you are running a lenny kernel and <code class="systemitem">udev</code>, you may reconfigure your system to access
disks by an alias that is not dependent upon driver load order.  These
aliases reside in the <code class="filename">/dev/disk/</code> hierarchy.
</p></div><div class="section" lang="zh-CN" xml:lang="zh-CN"><div class="titlepage"><div><div><h3 class="title"><a id="boot-timing"></a>4.6.5. 引导期间的问题</h3></div></div></div><p>
If an initrd created with <code class="systemitem">initramfs-tools</code> is used to boot the system, in
some cases the creation of device files by <code class="systemitem">udev</code> can happen too late for the boot scripts to
act on.
</p><p>
The usual symptoms are that the boot will fail because the root file system
cannot be mounted and you are dropped into a debug shell, but that when you
check afterwards, all devices that are needed are present in
<code class="filename">/dev</code>.  This has been observed in cases where the root
file system is on a <acronym title="通用串行总线">USB</acronym> disk or on
<acronym title="独立冗余磁盘阵列">RAID</acronym>, especially if lilo is used.
</p><p>
A workaround for this issue is to use the boot parameter
<code class="literal">rootdelay=<em class="replaceable"><code>9</code></em></code>.  The value for
the timeout (in seconds) may need to be adjusted.
</p></div></div><div class="section" lang="zh-CN" xml:lang="zh-CN"><div class="titlepage"><div><div><h2 class="title" style="clear: both"><a id="nownownow"></a>4.7. 在重启之前要做的事情</h2></div></div></div><p>
When <code class="literal">aptitude dist-upgrade</code> has finished, the
“<span class="quote">formal</span>” upgrade is complete, but there are some other things
that should be taken care of <span class="emphasis"><em>before</em></span> the next reboot.
</p><div class="section" lang="zh-CN" xml:lang="zh-CN"><div class="titlepage"><div><div><h3 class="title"><a id="rerunlilo"></a>4.7.1. 重新运行 lilo</h3></div></div></div><p>
If you are using <code class="systemitem">lilo</code> as your
bootloader (it is the default bootloader for some installations of
etch) it is strongly recommended that you rerun
<span class="command"><strong>lilo</strong></span> after the upgrade:
</p><pre class="screen">
# /sbin/lilo
</pre><p>
Notice this is needed even if you did not upgrade your system's kernel, as
<span class="command"><strong>lilo</strong></span>'s second stage will change due to the package
upgrade.
</p><p>
Also, review the contents of your <code class="filename">/etc/kernel-img.conf</code>
and make sure that you have <code class="literal">do_bootloader = Yes</code> in it.
That way the bootloader will always be rerun after a kernel upgrade.
</p><p>
If you encounter any issues when running <span class="command"><strong>lilo</strong></span>, review the
symbolic links in <code class="filename">/</code> to <code class="filename">vmlinuz</code> and
<code class="filename">initrd</code> and the contents of your
<code class="filename">/etc/lilo.conf</code> for discrepancies.
</p><p>
If you forgot to rerun <span class="command"><strong>lilo</strong></span> before the reboot or the
system is accidentally rebooted before you could do this manually, your
system might fail to boot.  Instead of the lilo prompt, you will only see
<code class="literal">LI</code> when booting the system<sup>[<a id="id549433" href="#ftn.id549433" class="footnote">9</a>]</sup>.  See <a class="xref" href="ch-upgrading.zh_CN.html#recovery" title="4.1.3. 准备恢复">第 4.1.3 节 “准备恢复”</a> for information on how to
recover from this.
</p></div><div class="section" lang="zh-CN" xml:lang="zh-CN"><div class="titlepage"><div><div><h3 class="title"><a id="mdadm"></a>4.7.2. 升级 mdadm</h3></div></div></div><p>
mdadm now needs a configuration file to assemble MD arrays
(<acronym title="独立冗余磁盘阵列">RAID</acronym>) from the initial ramdisk and during the system
initialisation sequence.  Please make sure to read and act upon the
instructions in
<code class="filename">/usr/share/doc/mdadm/README.upgrading-2.5.3.gz</code> after
the package has been upgraded <span class="strong"><strong>and before you
reboot</strong></span>.  The latest version of this file is available at <a class="ulink" href="http://svn.debian.org/wsvn/pkg-mdadm/mdadm/trunk/debian/README.upgrading-2.5.3?op=file" target="_top">http://svn.debian.org/wsvn/pkg-mdadm/mdadm/trunk/debian/README.upgrading-2.5.3?op=file</a>;
please consult it in case of problems.
</p></div></div><div class="section" lang="zh-CN" xml:lang="zh-CN"><div class="titlepage"><div><div><h2 class="title" style="clear: both"><a id="boot-hangs"></a>4.8. 系统引导时在显示 <code class="literal">Waiting for root file system</code> 后挂起</h2></div><div><h3 class="subtitle">Procedure to recover from <code class="filename">/dev/hda</code> became
<code class="filename">/dev/sda</code></h3></div></div></div><p>
    Some users have reported that an upgrade could cause the kernel not finding
the system root partition after a system reboot.
  </p><p>
    In such case, the system boot will hang on the following message:
    </p><pre class="screen">Waiting for root file system ...</pre><p>
    and after a few seconds a bare busybox prompt will show.
  </p><p>
    This problem can occur when the upgrade of the kernel introduces the use of
the new generation of <acronym title="电子集成驱动器">IDE</acronym> drivers. The
<acronym title="电子集成驱动器">IDE</acronym> disk naming convention for the old drivers was
<code class="literal">hda</code>, <code class="literal">hdb</code>, <code class="literal">hdc</code>,
<code class="literal">hdd</code>. The new drivers will name the same disks
respectively <code class="literal">sda</code>, <code class="literal">sdb</code>,
<code class="literal">sdc</code>, <code class="literal">sdd</code>. The problem appears when the
upgrade does not generate a new <code class="filename">/boot/grub/menu.lst</code>
file to take the new naming convention into account. During the boot, Grub
will pass a system root partition to the kernel that the kernel doesn't
find.
  </p><p>
    If you have encountered this problem after upgrading, jump to <a class="xref" href="ch-upgrading.zh_CN.html#how-to-recover" title="4.8.2. 如何在升级后解决此问题">第 4.8.2 节 “如何在升级后解决此问题”</a>. To avoid the problem before upgrading, read
ahead.
  </p><div class="section" lang="zh-CN" xml:lang="zh-CN"><div class="titlepage"><div><div><h3 class="title"><a id="avoid-problems-before-upgrading"></a>4.8.1. 如何在升级前避免此问题</h3></div></div></div><p>
      One can avoid this problem entirely by using an identifier for the root
filesystem that does not change from one boot to the next. There are two
possible methods for doing this - labelling the filesystem, or using the
filesystem's universal unique identifier (<acronym title="通用惟一标识符">UUID</acronym>). These
methods are supported in Debian since the 'etch' release.
    </p><p>
      The two approaches have advantages and disadvantages. The labelling approach
is more readable, but there may be problems if another filesystem on your
machine has the same label. The uuid approach is uglier, but having two
clashing uuids is highly unlikely.
    </p><p>
      For the examples below we assume the root filesystem is on
<code class="filename">/dev/hda6</code>. We also assume your system has a working
udev installation and ext2 or ext3 filesystems.
    </p><p>
      To implement the labelling approach:
      </p><div class="orderedlist"><ol type="1"><li><p>
	    Label the filesystem (the name must be &lt; 16 characters)  by running the
command:
	    </p><pre class="programlisting">e2label /dev/hda6 rootfilesys</pre><p>
	  </p></li><li><p>
	    Edit <code class="filename">/boot/grub/menu.lst</code> and change the line:
	    </p><pre class="programlisting"># kopt=root=/dev/hda6 ro</pre><p>
	    to
	    </p><pre class="programlisting"># kopt=root=LABEL=rootfilesys ro</pre><p>
	    </p><div class="note" style="margin-left: 0.5in; margin-right: 0.5in;"><table border="0" summary="Note"><tr><td rowspan="2" align="center" valign="top" width="25"><img alt="[注意]" src="images/note.png" /></td><th align="left">注意</th></tr><tr><td align="left" valign="top"><p>
		Do not remove the <code class="literal">#</code> at the start of the line, it needs to
be there.
	      </p></td></tr></table></div><p>
	  </p></li><li><p>
	    Update the <code class="literal">kernel</code> lines in <code class="filename">menu.lst</code>
by running the command <span class="command"><strong>update-grub</strong></span>.
	  </p></li><li><p>
	    Edit <code class="filename">/etc/fstab</code> and change the line that mounts the
<code class="filename">/</code> partition, eg.:

	    </p><pre class="programlisting">/dev/hda6     /     ext3  defaults,errors=remount-ro 0 1</pre><p>

	    to

	    </p><pre class="programlisting">LABEL=rootfilesys     /     ext3  defaults,errors=remount-ro 0 1</pre><p>

	    The change that matters here is the first column, you don't need to modify
the other columns of this line.
	  </p></li></ol></div><p>
    </p><p>
      To implement the uuid approach:
      </p><div class="orderedlist"><ol type="1"><li><p>
	    Find out the universal unique identifier of your filesystem by issuing:
<span class="command"><strong>ls -l /dev/disk/by-uuid | grep hda6</strong></span>
	  </p><p>
	    You should get a line similar to this one:
	    </p><pre class="screen">lrwxrwxrwx 1 root root 24 2008-09-25 08:16 d0dfcc8a-417a-41e3-ad2e-9736317f2d8a -&gt; ../../hda6</pre><p>

	    The <acronym title="通用惟一标识符">UUID</acronym> is the name of the symbolic link pointing to
<code class="filename">/dev/hda6</code> ie.:
<code class="literal">d0dfcc8a-417a-41e3-ad2e-9736317f2d8a</code>.
	    </p><div class="note" style="margin-left: 0.5in; margin-right: 0.5in;"><table border="0" summary="Note"><tr><td rowspan="2" align="center" valign="top" width="25"><img alt="[注意]" src="images/note.png" /></td><th align="left">注意</th></tr><tr><td align="left" valign="top"><p>
		Your filesystem <acronym title="通用惟一标识符">UUID</acronym> will be a different string.
	      </p></td></tr></table></div><p>
	  </p></li><li><p>
	    Edit <code class="filename">/boot/grub/menu.lst</code> and change the line

	    </p><pre class="programlisting"># kopt=root=/dev/hda6 ro</pre><p>

	    to

	    </p><pre class="programlisting"># kopt=root=UUID=d0dfcc8a-417a-41e3-ad2e-9736317f2d8 ro</pre><p>

	    </p><div class="note" style="margin-left: 0.5in; margin-right: 0.5in;"><table border="0" summary="Note"><tr><td rowspan="2" align="center" valign="top" width="25"><img alt="[注意]" src="images/note.png" /></td><th align="left">注意</th></tr><tr><td align="left" valign="top"><p>
		Do not remove the <code class="literal">#</code> at the start of the line, it needs to
be there.
	      </p></td></tr></table></div><p>
	  </p></li><li><p>
	    Update the <code class="literal">kernel</code> lines in <code class="filename">menu.lst</code>
by running the command <span class="command"><strong>update-grub</strong></span>.
	  </p></li><li><p>
	    Edit <code class="filename">/etc/fstab</code> and change the line that mounts the
<code class="filename">/</code> partition, eg.:

	    </p><pre class="programlisting">/dev/hda6     /     ext3  defaults,errors=remount-ro 0 1</pre><p>

	    to

	    </p><pre class="programlisting">UUID=d0dfcc8a-417a-41e3-ad2e-9736317f2d8  /  ext3  defaults,errors=remount-ro 0 1</pre><p>

	    The change that matters here is the first column, you don't need to modify
the other columns of this line.
	  </p></li></ol></div><p>
    </p></div><div class="section" lang="zh-CN" xml:lang="zh-CN"><div class="titlepage"><div><div><h3 class="title"><a id="how-to-recover"></a>4.8.2. 如何在升级后解决此问题</h3></div></div></div><div class="section" lang="zh-CN" xml:lang="zh-CN"><div class="titlepage"><div><div><h4 class="title"><a id="solution1"></a>4.8.2.1. 方案一</h4></div></div></div><p>
	This is applicable when Grub shows you the menu interface for selecting the
entry you want to boot from. If such menu does not appear, try pressing
<span class="keycap"><strong>Esc</strong></span> key before the kernel boots in order to make it
appear.  If you can't get into this menu, try <a class="xref" href="ch-upgrading.zh_CN.html#solution2" title="4.8.2.2. 方案二">第 4.8.2.2 节 “方案二”</a> or
<a class="xref" href="ch-upgrading.zh_CN.html#solution3" title="4.8.2.3. 方案三">第 4.8.2.3 节 “方案三”</a>.
      </p><div class="orderedlist"><ol type="1"><li><p>
	    In the Grub menu, highlight the entry you want to boot from. Press
<span class="keycap"><strong>e</strong></span> key to edit the options related to this entry. You will
see something like:

	    </p><pre class="screen">root (hd0,0)
kernel /vmlinuz-2.6.26-1-686 root=/dev/hda6 ro
initrd /initrd.img-2.6.26-1-686</pre><p>
	  </p></li><li><p>
	    Highlight the line

	    </p><pre class="screen">kernel /vmlinuz-2.6.26-1-686 root=/dev/hda6 ro</pre><p>

	    press <span class="keycap"><strong>e</strong></span> key and replace <code class="literal">hdX</code> with
<code class="literal">sd<em class="replaceable"><code>X</code></em></code> (<code class="varname">X</code>
being the letter <code class="literal">a</code>, <code class="literal">b</code>,
<code class="literal">c</code> or <code class="literal">d</code> depending of your system), In
my example the line becomes:

	    </p><pre class="screen">kernel /vmlinuz-2.6.26-1-686 root=/dev/sda6 ro</pre><p>

	    Then press <span class="keycap"><strong>Enter</strong></span> to save the modification. If other lines
show <code class="literal">hd<em class="replaceable"><code>X</code></em></code>, change these line
too. Don't modify the entry similar to <code class="literal">root (hd0,0)</code>.
Once all modifications are done, press <span class="keycap"><strong>b</strong></span> key. And your
system should now boot as usual.
	  </p></li><li><p>
	    Now that your system has booted, you need to fix this issue permanently.
Jump to <a class="xref" href="ch-upgrading.zh_CN.html#avoid-problems-before-upgrading" title="4.8.1. 如何在升级前避免此问题">第 4.8.1 节 “如何在升级前避免此问题”</a> and apply one of
the two proposed procedures.
	  </p></li></ol></div></div><div class="section" lang="zh-CN" xml:lang="zh-CN"><div class="titlepage"><div><div><h4 class="title"><a id="solution2"></a>4.8.2.2. 方案二</h4></div></div></div><p>
	Boot from a debian installation media
(<acronym title="光盘">CD</acronym>/<acronym title="数字通用光盘">DVD</acronym>) and when prompt, type
<code class="literal">rescue</code> to launch the rescue mode. Select your language,
location, keyboard mapping, let it configure the network no matter if it
success or not. After a while, you should be asked for selecting a partition
you want to use as root file system. The proposed choices will look
something like:

	</p><pre class="screen">/dev/ide/host0/bus0/target0/lun0/part1
/dev/ide/host0/bus0/target0/lun0/part2
/dev/ide/host0/bus0/target0/lun0/part5
/dev/ide/host0/bus0/target0/lun0/part6</pre><p>
      </p><p>
	If you know which partition is your root file system, choose the right
one. If you don't, just try with the first. If it complains about an invalid
root file system partition, try the next one, and so on. Trying one after
the other shouldn't arm your partitions and if you have only one system
installed on your disks, you should easily find the right root file system
partition. If you have many systems installed on your disks, it would be
better to know exactly which is the right partition.
      </p><p>
	Once you have choosen a partition, you will be proposed among several
actions.  Make the choice of executing a shell in the selected partition. If
it complains that it cannot do that then try with another partition.
      </p><p>
	Now you should have shell access as user root on your root file system
mounted on <code class="filename">/</code>. You need access to the
<code class="filename">/boot</code>, <code class="filename">/sbin</code> and
<code class="filename">/usr</code> directories content. If these directories need to
be mounted from other partitions, do it.  (see
<code class="filename">/etc/fstab</code> if you have no idea of which partition to
mount).
      </p><p>
	Jump to <a class="xref" href="ch-upgrading.zh_CN.html#avoid-problems-before-upgrading" title="4.8.1. 如何在升级前避免此问题">第 4.8.1 节 “如何在升级前避免此问题”</a> and apply one of
the two proposed procedures to fix the problem parmanently. Then type
<code class="literal">exit</code> to leave the rescue shell and select
<code class="literal">reboot</code> for rebooting the system as usual. (Don't forget
to remove the bootable media)
      </p></div><div class="section" lang="zh-CN" xml:lang="zh-CN"><div class="titlepage"><div><div><h4 class="title"><a id="solution3"></a>4.8.2.3. 方案三</h4></div></div></div><div class="orderedlist"><ol type="1"><li><p>
	    Boot from your favorite LiveCD distribution (Debian Live, Knoppix, Ubuntu
Live and many other).
	  </p></li><li><p>
	    Mount the partition where your <code class="filename">/boot</code> directory is. If
you don't know which one it is, use the output of the command
<span class="command"><strong>dmesg</strong></span> to find whether your disk is known as
<code class="literal">hda</code>, <code class="literal">hdb</code>, <code class="literal">hdc</code>,
<code class="literal">hdd</code> or <code class="literal">sda</code>, <code class="literal">sdb</code>,
<code class="literal">sdc</code>, <code class="literal">sdd</code>. Once you know which disk to
work on, for example <code class="literal">sdb</code>, issue the following command to
see the partition table of the disk and to find the right partition
<span class="command"><strong>fdisk -l /dev/sdb</strong></span>
	  </p></li><li><p>
	    Assuming that you have mounted the right partition under
<code class="filename">/mnt</code> and that this partition contains the
<code class="filename">/boot</code> directory and its content, edit the
<code class="filename">/mnt/boot/grub/menu.lst</code> file.
	  </p><p>
	    找到类似于以下的这一段：
	    </p><pre class="programlisting">## ## End Default Options ##

title           Debian GNU/Linux, kernel 2.6.26-1-686
root            (hd0,0)
kernel          /vmlinuz-2.6.26-1-686 root=/dev/hda6 ro
initrd          /initrd.img-2.6.26-1-686

title           Debian GNU/Linux, kernel 2.6.26-1-686 (single-user mode)
root            (hd0,0)
kernel          /vmlinuz-2.6.26-1-686 root=/dev/hda6 ro single
initrd          /initrd.img-2.6.26-1-686

### END DEBIAN AUTOMAGIC KERNELS LIST</pre><p>

	    并将
<code class="literal">hda</code>，<code class="literal">hdb</code>，<code class="literal">hdc</code>，<code class="literal">hdd</code>
分别替换为
<code class="literal">sda</code>，<code class="literal">sdb</code>，<code class="literal">sdc</code>，<code class="literal">sdd</code>。不要修改类似于这样的行：

	    </p><pre class="screen">root            (hd0,0)</pre><p>
	  </p></li><li><p>
	    重启系统，弹出 LiveCD，您的系统应该能正确的启动了。
	  </p></li><li><p>
	    当系统引导时，使用 <a class="xref" href="ch-upgrading.zh_CN.html#avoid-problems-before-upgrading" title="4.8.1. 如何在升级前避免此问题">第 4.8.1 节 “如何在升级前避免此问题”</a>
中所建议的两个处理过程中的一个来永久修复这个问题。
	  </p></li></ol></div></div></div></div><div class="section" lang="zh-CN" xml:lang="zh-CN"><div class="titlepage"><div><div><h2 class="title" style="clear: both"><a id="for-next"></a>4.9. 为下个发行版做准备</h2></div></div></div><p>
升级完成后，您可以为下个发行版做点事。
</p><div class="itemizedlist"><ul type="disc"><li><p>
如果您使用 <code class="systemitem">grub</code>，那就编辑
<code class="filename">/etc/kernel-img.conf</code> 并将 <span class="command"><strong>update-grub</strong></span>
程序的位置从 <code class="filename">/sbin/update-grub</code> 改为
<code class="filename">/usr/sbin/update-grub</code>。
</p></li><li><p>
如果新的内核镜像元数据包被当作旧镜像的依赖包而安装，那新镜像将被标记为自动安装，这应该被改正：
</p><pre class="screen">
# aptitude unmarkauto $(dpkg-query -W 'linux-image-2.6-*' | cut -f1)
</pre></li><li><p>
用以下命令移除 etch 的内核元数据包：
</p><pre class="screen">
# aptitude purge kernel-image-2.6-<em class="replaceable"><code>flavor</code></em>
</pre></li><li><p>
将 <code class="filename">/etc/network/options</code> 中的所有配置选项移入
<code class="filename">/etc/sysctl.conf</code> 中。详细内容请参看
<code class="filename">/usr/share/doc/netbase/README.Debian</code>。
</p></li><li><p>
像 <a class="xref" href="ch-upgrading.zh_CN.html#obsolete" title="4.11. 过时的包">第 4.11 节 “过时的包”</a>
中描述的那样移除过时的和未使用的包。您应该核查这些包所用的配置文件，并考虑完全删除这些包以移除它们的配置文件。
</p></li></ul></div></div><div class="section" lang="zh-CN" xml:lang="zh-CN"><div class="titlepage"><div><div><h2 class="title" style="clear: both"><a id="deprecated"></a>4.10. 不赞成地包</h2></div></div></div><p>
随着 <code class="literal">Lenny</code> 版的发行，大量的服务包都将不赞成使用，因此当升级至
<code class="literal">Lenny</code> 版时更新至这些包的新版本可以解决您的困扰。
</p><p>
包含以下这些包：
</p><div class="itemizedlist"><ul type="disc"><li><p>
apache (1.x)，由 apache2 替代
</p></li><li><p>
bind8，由 bind9 替代
</p></li><li><p>
php4，由 php5 替代
</p></li><li><p>
postgresql-7.4，由 postgresql-8.1 替代
</p></li><li><p>
exim 3，由 exim4 替代
</p></li></ul></div></div><div class="section" lang="zh-CN" xml:lang="zh-CN"><div class="titlepage"><div><div><h2 class="title" style="clear: both"><a id="obsolete"></a>4.11. 过时的包</h2></div></div></div><p>
在带来几千个新软件包的同时，lenny 也清除了曾经存在于 etch
中超过两千个的旧软件包。lenny 不提供这些过时包的升级。当然，在您需要的地方没什么可以阻止您继续使用这些过时的包，Debian
计划通常会在 lenny 发行版后的一年间不断的提供安全更新<sup>[<a id="id550623" href="#ftn.id550623" class="footnote">10</a>]</sup>，且通常不会同时提供其它支持。推荐用可用的替代品代替它们。
</p><p>
为什么包会从发行版中移除？这有很多原因，如：它们不再被上游作者维护了；没有 Debian
开发者对维护这个包感兴趣；这些包提供的功能被不同的软件（或新版本）替代了；或者由于它们自身的问题，因而被认为不适用于 lenny。
最后一种情况下，这些包有可能仍然位于 “<span class="quote">unstable</span>” 版之下。
</p><p>
检测在已更新的系统中哪些包是“<span class="quote">过时</span>”的现在容易得很，因为包管理的前台程序会标记它们的。如果您使用的是
<span class="command"><strong>aptitude</strong></span>，您将在 “<span class="quote">过期的和在本地创建的包</span>”
条目中看到这些包。<span class="command"><strong>dselect</strong></span> 提供类似的条目，但它显示的列表有所不同。还有，如果您曾经用
<span class="command"><strong>aptitude</strong></span> 手工在 etch 中安装过包，aptitude
会保存那些您手工安装的记录。如果有某个包被移除并导致出现无依赖性，即不再需要那些包，aptitude 会那些包标记为过时的包。还有
<span class="command"><strong>aptitude</strong></span>，不同于
<span class="command"><strong>deborphan</strong></span>。<span class="command"><strong>deborphan</strong></span>
不将您手工安装过的包，而非那些通过依赖性自动安装的软件包，标记为过时的包。
</p><p>
您可以用其它的工具来找出过时的包，例如
<span class="command"><strong>deborphan</strong></span>，<span class="command"><strong>debfoster</strong></span> 或
<span class="command"><strong>cruft</strong></span>。 推荐使用
<span class="command"><strong>deborphan</strong></span>，尽管它（默认情况下）只报告过时的库，即
“<span class="quote"><code class="literal">libs</code></span>” 或是
“<span class="quote"><code class="literal">oldlibs</code></span>”
部分中的未被其它包依赖的软件包。不要盲目的移除那些工具要用到的包，尤其是当您正在使用激进的非默认的选项，它们容易引起严重错误。极度推荐在您移除它们之前，手工核查那些建议移除的包（例如：它们的内容、大小以及描述信息）。
</p><p>
<a class="ulink" href="http://bugs.debian.org/" target="_top"> Debian
错误跟踪系统</a>通常会提供额外信息，这些都是有关这个包为什么要被移除的信息。您应该既查看此包自身的归档错误报告，同时也要看一下 <a class="ulink" href="http://bugs.debian.org/cgi-bin/pkgreport.cgi?pkg=ftp.debian.org&amp;archive=yes" target="_top">ftp.debian.org
pseudo-package</a> 中的归档错误报告。
</p><div class="section" lang="zh-CN" xml:lang="zh-CN"><div class="titlepage"><div><div><h3 class="title"><a id="dummy"></a>4.11.1. 哑包</h3></div></div></div><p>
来自 etch 的某些包在 lenny
中已经被分为好几个包，通常这是为了改善系统的可维护性。在此情况下，为了能平滑升级，lenny
通常提供“<span class="quote">哑</span>”包（即空包），它与 etch
中的旧包名称相同，但有依赖性，促使它们安装新包。这些“<span class="quote">哑</span>”包在升级成功后就会被认为是过时的包，且能够被安全地移除。
</p><p>
绝大多数（并非所有）哑包的描述信息会显示它们的用途。但哑包的描述信息并不统一，因此你可能会发现带上<code class="literal"> --guess
</code>选项的<span class="command"><strong> deborphan
</strong></span>命令对于找出您系统中的哑包是很有用的。注意，某些哑包在升级后是不打算被系统移除的，相反它们被用于长期跟踪某程序的当前可用版本这样的目的。
</p></div></div><div class="section" lang="zh-CN" xml:lang="zh-CN"><div class="titlepage"><div><div><h2 class="title" style="clear: both"><a id="plans-for-nigel"></a>4.12. 下个 Debian 发行版的计划</h2></div></div></div></div><div class="footnotes"><br /><hr width="100" align="left" /><div class="footnote"><p><sup>[<a id="ftn.id545891" href="#id545891" class="para">3</a>] </sup> 此功能可以通过在您的启动参数中添加参数 <code class="literal">panic=0</code> 来禁用。  </p></div><div class="footnote"><p><sup>[<a id="ftn.id546524" href="#id546524" class="para">4</a>] </sup> Debian 的包管理系统正常情况下不允许一个包移除或是替换另一个包所拥有的文件，除非已经被设定为替换那个包。  </p></div><div class="footnote"><p><sup>[<a id="ftn.id547504" href="#id547504" class="para">5</a>] </sup> 由于下一节将要谈到的问题，在开始更新时执行这条命令可能会给出一个错误。如果那样的话，您需要等至已经如<a class="xref" href="ch-upgrading.zh_CN.html#minimal-upgrade" title="4.5.6. 最小系统升级">第 4.5.6 节 “最小系统升级”</a>所述的那样做过最小系统升级并且如 <a class="xref" href="ch-upgrading.zh_CN.html#upgrading-kernel" title="4.5.7. 升级内核">第 4.5.7 节 “升级内核”</a>中所述的那样升级过内核后，这样，您才可以运行这条命令来估计所需的磁盘空间。  </p></div><div class="footnote"><p><sup>[<a id="ftn.id548158" href="#id548158" class="para">6</a>] </sup> This command will determine whether you need libfam0 and xlibmesa-glu
installed, and auto-select them for you:
</p><pre class="screen"> # aptitude install x11-common \ $(dpkg-query --showformat
'${Package} ${Status}\n' -W libfam0c102 xlibmesa-glu \ | grep 'ok installed$' |
sed -e's/ .*//; s/c102//') </pre></div><div class="footnote"><p><sup>[<a id="ftn.id549015" href="#id549015" class="para">7</a>] </sup> You can have the kernel modules needed by your system loaded statically
through proper configuration of <code class="filename">/etc/modules</code>.</p></div><div class="footnote"><p><sup>[<a id="ftn.id549081" href="#id549081" class="para">8</a>] </sup>
The rules there are automatically generated by the script
<code class="filename">/etc/udev/rules.d/z45_persistent-net-generator.rules</code> to
have persistent names for network interfaces.  Delete this symlink to
disable persistent device naming for NICs by <code class="systemitem">udev</code>.  </p></div><div class="footnote"><p><sup>[<a id="ftn.id549433" href="#id549433" class="para">9</a>] </sup> For more information on <span class="command"><strong>lilo</strong></span>'s boot error codes please
see <a class="ulink" href="http://tldp.org/HOWTO/Bootdisk-HOWTO/a1483.html" target="_top">The Linux
Bootdisk HOWTO</a>.  </p></div><div class="footnote"><p><sup>[<a id="ftn.id550623" href="#id550623" class="para">10</a>] </sup> 否则只要在那段时间内没有另外的发行版释出。在任意给定时间内，一般仅提供两个 stable 发行版的安装更新。  </p></div></div></div><div class="navfooter"><hr /><table width="100%" summary="Navigation footer"><tr><td width="40%" align="left"><a accesskey="p" href="ch-installing.zh_CN.html">上一页</a> </td><td width="20%" align="center"> </td><td width="40%" align="right"> <a accesskey="n" href="ch-information.zh_CN.html">下一页</a></td></tr><tr><td width="40%" align="left" valign="top">第 3 章 安装系统 </td><td width="20%" align="center"><a accesskey="h" href="index.zh_CN.html">起始页</a></td><td width="40%" align="right" valign="top"> 第 5 章 lenny 中需要注意的问题</td></tr></table></div></body></html>
